<!doctype html>
<html>

	<head>
		<meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, max				// Auto-redirect to interactive view when reaching maximum zoom - TEMPORARILY DISABLED
				if (currentZoom >= maxZoom) {
					// Show special transition message
					showTransitionMessage();
					// setTimeout(function() {
					// 	window.location.href = currentOrgan.interactivePage;
					// }, 1500); // Longer delay for smooth transition
				}le=1.0'>
		<script src="vendor/three.101.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.101.1/examples/js/loaders/GLTFLoader.js"></script>
		<script src="THREEAR.js"></script>
		<title id="page-title">AR Organ Explorer - Kids Anatomy</title>
		<!-- CSS Files -->
		<link rel="stylesheet" href="./css/base.css">
		<link rel="stylesheet" href="./css/organ-viewer.css">
	</head>
			

	<body>
		<!-- Loading Screen -->
		<div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 9999; font-family: Arial, sans-serif;">
			<div style="text-align: center; color: white;">
				<div id="loadingOrganEmoji" style="font-size: 100px; margin-bottom: 20px; animation: pulse 2s infinite;">ü´Ä</div>
				<h2 style="font-size: 32px; margin: 20px 0; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Loading AR Experience...</h2>
				<p id="loadingStatus" style="font-size: 18px; margin: 10px 0; opacity: 0.9;">Preparing assets...</p>
				
				<!-- Progress Bar Container -->
				<div style="width: 300px; height: 20px; background: rgba(255,255,255,0.2); border-radius: 10px; margin: 30px auto; overflow: hidden; box-shadow: 0 4px 10px rgba(0,0,0,0.2);">
					<div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #00f260, #0575e6); transition: width 0.3s ease; border-radius: 10px; box-shadow: 0 0 10px rgba(0,242,96,0.5);"></div>
				</div>
				
				<div id="loadingPercentage" style="font-size: 24px; font-weight: bold; margin-top: 10px;">0%</div>
				
				<!-- Loading Steps -->
				<div style="margin-top: 30px; font-size: 14px; opacity: 0.8;">
					<div id="step1" style="margin: 5px 0;">‚è≥ Loading 3D Model...</div>
					<div id="step2" style="margin: 5px 0; opacity: 0.5;">‚è≥ Loading AR Marker...</div>
					<div id="step3" style="margin: 5px 0; opacity: 0.5;">‚è≥ Initializing Camera...</div>
				</div>
			</div>
		</div>
		
		<style>
			@keyframes pulse {
				0%, 100% { transform: scale(1); }
				50% { transform: scale(1.1); }
			}
			
			.checkmark {
				color: #00f260;
			}
		</style>
		
		<!-- Compact Header Bar (hidden initially) -->
		<div class="header-bar" style="display: none;" id="headerBar">
			<h1 class="header-title" id="header-title">Organ Explorer</h1>
			<div class="header-controls">
				<button class="back-btn" onclick="window.history.back()">‚Üê Back</button>
			</div>
		</div>
		
		<!-- Floating Instructions (hidden initially) -->
		<div class="instructions-card" id="instructionsCard" style="display: none;">
			<p class="instructions-text" id="instructions-text">
				<span class="organ-emoji" id="organ-emoji">ü´Ä</span> Point your camera at the AR marker to see the organ! Use zoom controls to explore!
			</p>
		</div>
		
		<!-- Fun Fact Bubble (hidden initially) -->
		<div class="fact-bubble" style="display: none;">
			<p class="fact-text" id="fact-text">Amazing organ facts will appear here!</p>
		</div>
		
		<!-- Zoom Hint Popup -->
		<div class="zoom-hint" id="zoomHint" style="display: none;">
			üîç Zoom all the way in to explore the organ's details!
		</div>
		
		<!-- Compact Zoom Panel (hidden initially) -->
		<div class="zoom-panel" style="display: none;">
			<button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
			<div class="zoom-display" id="zoomDisplay">100%</div>
			<button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
		</div>
		
		<!-- Drag to Rotate Hint -->
		<div id="dragHint" style="
			position: fixed;
			bottom: 120px;
			left: 50%;
			transform: translateX(-50%);
			background: rgba(255, 255, 255, 0.95);
			padding: 12px 24px;
			border-radius: 20px;
			box-shadow: 0 4px 15px rgba(0,0,0,0.2);
			font-size: 14px;
			color: #333;
			font-weight: 600;
			display: none;
			z-index: 1000;
			text-align: center;
			animation: bounceIn 0.5s ease-out;
		">
			üëÜ Drag anywhere to rotate the model
		</div>

		<script src="./organ-configs.js"></script>
		<script>
			// Preloading System
			let totalAssets = 3; // 3D Model, AR Marker Data, Camera
			let loadedAssets = 0;
			let modelLoaded = false;
			let markerLoaded = false;
			
			function updateProgress(step, message) {
				loadedAssets++;
				const progress = (loadedAssets / totalAssets) * 100;
				
				document.getElementById('progressBar').style.width = progress + '%';
				document.getElementById('loadingPercentage').textContent = Math.round(progress) + '%';
				document.getElementById('loadingStatus').textContent = message;
				
				// Update step checkmarks
				if (step === 1) {
					document.getElementById('step1').innerHTML = '‚úÖ 3D Model Loaded';
					document.getElementById('step1').classList.add('checkmark');
					document.getElementById('step2').style.opacity = '1';
				} else if (step === 2) {
					document.getElementById('step2').innerHTML = '‚úÖ AR Marker Ready';
					document.getElementById('step2').classList.add('checkmark');
					document.getElementById('step3').style.opacity = '1';
				} else if (step === 3) {
					document.getElementById('step3').innerHTML = '‚úÖ Camera Initialized';
					document.getElementById('step3').classList.add('checkmark');
				}
				
				// If all assets loaded, hide loading screen
				if (loadedAssets >= totalAssets) {
					setTimeout(function() {
						document.getElementById('loadingScreen').style.opacity = '0';
						document.getElementById('loadingScreen').style.transition = 'opacity 0.5s';
						setTimeout(function() {
							document.getElementById('loadingScreen').style.display = 'none';
							document.getElementById('headerBar').style.display = 'flex';
							// Show UI elements
							document.getElementById('instructionsCard').style.display = 'block';
							document.querySelector('.fact-bubble').style.display = 'block';
							document.querySelector('.zoom-panel').style.display = 'flex';
							// Show drag hint after a delay
							setTimeout(function() {
								document.getElementById('dragHint').style.display = 'block';
								// Auto-hide drag hint after 5 seconds
								setTimeout(function() {
									var hint = document.getElementById('dragHint');
									if (hint) {
										hint.style.opacity = '0';
										hint.style.transition = 'opacity 0.5s';
									}
								}, 5000);
							}, 2000);
						}, 500);
					}, 500);
				}
			}
			
			// Get organ type from URL parameters
			const urlParams = new URLSearchParams(window.location.search);
			const organType = urlParams.get('organ') || 'heart';
			const currentOrgan = organConfigs[organType];
			
			// Update loading screen with organ emoji
			document.getElementById('loadingOrganEmoji').textContent = currentOrgan.emoji;

			// Apply CSS custom properties for dynamic theming
			const root = document.documentElement;
			const colors = currentOrgan.colors;
			root.style.setProperty('--primary-color', colors.primary);
			root.style.setProperty('--secondary-color', colors.secondary);
			root.style.setProperty('--fact-bg-1', colors.factBg1);
			root.style.setProperty('--fact-bg-2', colors.factBg2);
			root.style.setProperty('--fact-border', colors.factBorder);
			root.style.setProperty('--fact-text-color', colors.factTextColor);
			root.style.setProperty('--fact-text-shadow', colors.factTextShadow);
			root.style.setProperty('--hint-bg-1', colors.hintBg1);
			root.style.setProperty('--hint-bg-2', colors.hintBg2);
			root.style.setProperty('--hint-border', colors.hintBorder);

			// Update page content
			document.getElementById('page-title').textContent = `AR ${currentOrgan.name} Explorer - Kids Anatomy`;
			document.getElementById('header-title').textContent = currentOrgan.title;
			document.getElementById('organ-emoji').textContent = currentOrgan.emoji;
			document.getElementById('instructions-text').innerHTML = `<span class="organ-emoji">${currentOrgan.emoji}</span> ${currentOrgan.instructions}`;
			document.getElementById('fact-text').textContent = currentOrgan.funFact;
			document.getElementById('zoomHint').textContent = currentOrgan.hintText;

			// Initialize Three.js renderer with transparency
			var renderer = new THREE.WebGLRenderer({
				alpha: true,
				antialias: true
			});
			renderer.setClearColor(new THREE.Color('lightgrey'), 0);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.domElement.style.position = 'absolute';
			renderer.domElement.style.top = '0px';
			renderer.domElement.style.left = '0px';
			document.body.appendChild(renderer.domElement);
		
			// Initialize scene and camera
			var scene = new THREE.Scene();
			var camera = new THREE.Camera();
			scene.add(camera);

			// Create group for organ objects
			var organGroup = new THREE.Group();
			scene.add(organGroup);
			
			// Zoom variables
			var currentZoom = 1.0;
			var minZoom = 0.5;
			var maxZoom = 3.0;
			var zoomStep = 0.2;
			
			// Manual rotation variables
			var currentRotationY = 0; // Horizontal rotation (left-right)
			var currentRotationX = 0; // Vertical rotation (up-down)
			var rotationStep = 0.1; // Rotation step in radians
			
			// Auto-hide instructions after 8 seconds
			setTimeout(function() {
				var card = document.getElementById('instructionsCard');
				if (card) {
					card.classList.add('fade-out');
				}
			}, 8000);
			
			// Zoom functions
			function zoomIn() {
				if (currentZoom < maxZoom) {
					currentZoom += zoomStep;
					updateZoom();
					
					// Auto-redirect to interactive view when reaching maximum zoom - TEMPORARILY DISABLED
					if (currentZoom >= maxZoom) {
						// Show special transition message
						showTransitionMessage();
						// setTimeout(function() {
						// 	window.location.href = currentOrgan.interactivePage;
						// }, 1500); // Longer delay for smooth transition
					}
				}
			}
			
			function zoomOut() {
				if (currentZoom > minZoom) {
					currentZoom -= zoomStep;
					updateZoom();
				}
			}
			
			function updateZoom() {
				// Apply zoom to the organ group
				organGroup.userData.zoomScale = currentZoom;
				document.getElementById('zoomDisplay').textContent = Math.round(currentZoom * 100) + '%';
				
				// Show visual feedback when approaching max zoom
				var zoomDisplay = document.getElementById('zoomDisplay');
				if (currentZoom >= maxZoom * 0.8) {
					zoomDisplay.style.background = colors.hintBg1;
					zoomDisplay.style.color = 'white';
					zoomDisplay.style.borderColor = colors.hintBg1;
					// Hide zoom hint when close to max zoom
					document.getElementById('zoomHint').style.display = 'none';
				} else {
					zoomDisplay.style.background = 'white';
					zoomDisplay.style.color = colors.primary;
					zoomDisplay.style.borderColor = colors.primary;
				}
			}
			
			// Manual rotation functions
			function rotateLeft() {
				currentRotationY -= rotationStep;
				updateRotation();
			}
			
			function rotateRight() {
				currentRotationY += rotationStep;
				updateRotation();
			}
			
			function updateRotation() {
				// Apply rotation to the organ group (both X and Y axis)
				organGroup.userData.manualRotationY = currentRotationY;
				organGroup.userData.manualRotationX = currentRotationX;
			}
			
			// Function to show transition message
			function showTransitionMessage() {
				var hint = document.getElementById('zoomHint');
				hint.innerHTML = currentOrgan.transitionMessage;
				hint.style.background = `linear-gradient(135deg, ${colors.primary} 0%, ${colors.secondary} 100%)`;
				hint.style.display = 'block';
				hint.style.animation = 'pulse-hint 0.5s infinite';
			}
			
			// Function to show zoom hint
			function showZoomHint() {
				setTimeout(function() {
					document.getElementById('zoomHint').style.display = 'block';
					// Auto-hide after 6 seconds
					setTimeout(function() {
						document.getElementById('zoomHint').style.display = 'none';
					}, 6000);
				}, 4000); // Show hint 4 seconds after organ appears
			}

			// Initialize THREEAR source with HD camera settings
			var source = new THREEAR.Source({ 
				renderer, 
				camera,
				sourceWidth: 1920,  // Request 1080p resolution
				sourceHeight: 1080,
				displayWidth: window.innerWidth,
				displayHeight: window.innerHeight
			});
			
			// Update progress - Camera initializing
			updateProgress(3, 'Camera ready!');

			THREEAR.initialize({ source: source }).then((controller) => {
				
				// Update progress - AR Marker loaded
				updateProgress(2, 'AR Marker pattern loaded!');

				// Load 3D Organ Model with progress tracking
				var loader = new THREE.GLTFLoader();
				loader.load(currentOrgan.modelPath, function(gltf) {
					var organModel = gltf.scene;
					
					// Update progress - Model loaded
					updateProgress(1, `${currentOrgan.name} model loaded!`);
					
					// Scale the organ model to appropriate size for AR
					organModel.scale.set(currentOrgan.scale.x, currentOrgan.scale.y, currentOrgan.scale.z);
					organModel.position.y = currentOrgan.position.y;
					
					// Rotate kidney model to face front (like your existing code)
					if (organType === 'kidney') {
						organModel.rotation.y = Math.PI / 2; // 90 degrees
					}
					
					// Make the model lighter/brighter
					organModel.traverse(function(child) {
						if (child.isMesh) {
							if (child.material) {
								// Increase brightness and make materials more vibrant
								if (organType === 'lungs') {
									child.material.emissive = new THREE.Color(0.1, 0.2, 0.2); // Add slight teal glow
								} else {
									child.material.emissive = new THREE.Color(0.1, 0.1, 0.1); // General brightness boost
								}
								child.material.emissiveIntensity = 0.3;
								
								// If it has a color property, make it brighter
								if (child.material.color) {
									child.material.color.multiplyScalar(1.5); // Make 50% brighter
								}
							}
						}
					});
					
					// Add the organ model to the group
					organGroup.add(organModel);
					
					// Initialize zoom scale
					organGroup.userData.zoomScale = currentZoom;
					
					// Show zoom hint to encourage interaction
					showZoomHint();
					
					// Add animation to the model based on organ type
					var originalScale = currentOrgan.scale;
					var time = 0;
					
					// Animation loop
					function animateOrgan() {
						time += 0.016; // 60fps
						
						var animationScale = 1;
						if (currentOrgan.animationType === 'beating') {
							// Heart beating animation
							animationScale = 1 + Math.sin(time * 4) * 0.1;
						} else if (currentOrgan.animationType === 'breathing') {
							// Lungs breathing animation
							animationScale = 1 + Math.sin(time * 2) * 0.1;
						} else if (currentOrgan.animationType === 'pulsing') {
							// General pulsing animation
							animationScale = 1 + Math.sin(time * 3) * 0.05;
						}
						
						// Apply both zoom and animation
						var zoomScale = organGroup.userData.zoomScale || 1.0;
						organModel.scale.set(
							originalScale.x * animationScale * zoomScale,
							originalScale.y * animationScale * zoomScale,
							originalScale.z * animationScale * zoomScale
						);
						
						// Apply manual rotation on both X and Y axes
						var manualRotationY = organGroup.userData.manualRotationY || 0;
						var manualRotationX = organGroup.userData.manualRotationX || 0;
						
						// Clamp X rotation to prevent flipping upside down (limit to -90 to +90 degrees)
						manualRotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, manualRotationX));
						
						if (organType !== 'kidney') {
							organModel.rotation.y = manualRotationY;
							organModel.rotation.x = manualRotationX;
						} else {
							// For kidney, add manual rotation to the fixed rotation
							organModel.rotation.y = Math.PI / 2 + manualRotationY;
							organModel.rotation.x = manualRotationX;
						}
					}
					
					// Start the animation
					var animationId;
					function animate() {
						animationId = requestAnimationFrame(animate);
						animateOrgan();
						
						controller.update(source.domElement);
						renderer.render(scene, camera);
					}
					animate();
					
				}, function(progress) {
					console.log(`Loading ${currentOrgan.name} model...`, (progress.loaded / progress.total * 100) + '%');
				}, function(error) {
					console.error(`Error loading ${currentOrgan.name} model:`, error);
					// Fallback to simple geometry if model fails to load
					createSimpleOrgan();
				});

				// Fallback function to create simple organ if GLTF fails
				function createSimpleOrgan() {
					var organGeometry, organMaterial, organMesh;
					
					// Create different shapes based on organ type
					if (organType === 'heart') {
						organGeometry = new THREE.SphereGeometry(0.3, 16, 16);
						organMaterial = new THREE.MeshPhongMaterial({ color: 0xff6b6b, transparent: true, opacity: 0.8 });
					} else if (organType === 'brain') {
						organGeometry = new THREE.SphereGeometry(0.35, 12, 12);
						organMaterial = new THREE.MeshPhongMaterial({ color: 0x8e44ad, transparent: true, opacity: 0.8 });
					} else if (organType === 'lungs') {
						// Create two lung shapes
						var leftLungGeometry = new THREE.CylinderGeometry(0.15, 0.25, 0.6, 12);
						var leftLungMaterial = new THREE.MeshPhongMaterial({ color: 0x4ecdc4, transparent: true, opacity: 0.8 });
						var leftLung = new THREE.Mesh(leftLungGeometry, leftLungMaterial);
						leftLung.position.set(-0.2, 0.5, 0);
						organGroup.add(leftLung);

						var rightLungGeometry = new THREE.CylinderGeometry(0.15, 0.25, 0.6, 12);
						var rightLungMaterial = new THREE.MeshPhongMaterial({ color: 0x4ecdc4, transparent: true, opacity: 0.8 });
						var rightLung = new THREE.Mesh(rightLungGeometry, rightLungMaterial);
						rightLung.position.set(0.2, 0.5, 0);
						organGroup.add(rightLung);
						
						showZoomHint();
						return; // Exit early for lungs
					} else if (organType === 'liver') {
						organGeometry = new THREE.BoxGeometry(0.4, 0.3, 0.2);
						organMaterial = new THREE.MeshPhongMaterial({ color: 0xff9f43, transparent: true, opacity: 0.8 });
					} else if (organType === 'kidney') {
						organGeometry = new THREE.SphereGeometry(0.25, 12, 12);
						organGeometry.scale(1, 1.5, 0.8); // Make it kidney-shaped
						organMaterial = new THREE.MeshPhongMaterial({ color: 0x26de81, transparent: true, opacity: 0.8 });
					} else {
						// Default fallback
						organGeometry = new THREE.SphereGeometry(0.3, 16, 16);
						organMaterial = new THREE.MeshPhongMaterial({ color: 0x666666, transparent: true, opacity: 0.8 });
					}
					
					organMesh = new THREE.Mesh(organGeometry, organMaterial);
					organMesh.position.y = 0.5;
					organGroup.add(organMesh);
					
					// Show zoom hint for fallback organ too
					showZoomHint();
				}

				// Add lighting for better organ appearance
				var ambientLight = new THREE.AmbientLight(0x404040, 2.5); // Enhanced ambient light
				scene.add(ambientLight);
				
				var directionalLight = new THREE.DirectionalLight(0xffffff, 3.0); // Enhanced directional light
				directionalLight.position.set(1, 1, 1);
				scene.add(directionalLight);
				
				// Add additional point lights for better illumination
				var pointLight1 = new THREE.PointLight(0xffffff, 1.5, 10);
				pointLight1.position.set(2, 2, 2);
				scene.add(pointLight1);
				
				var pointLight2 = new THREE.PointLight(0xffffff, 1.0, 8);
				pointLight2.position.set(-2, 1, -1);
				scene.add(pointLight2);
				
				// Add additional soft lighting for better visibility
				var hemisphereLight = new THREE.HemisphereLight(0xffffff, 0x444444, 0.6);
				scene.add(hemisphereLight);

				// Create pattern marker for tracking
				var patternMarker = new THREEAR.PatternMarker({
					patternUrl: 'data/patt.hiro',
					markerObject: organGroup
				});

				controller.trackMarker(patternMarker);

				// Handle window resize
				window.addEventListener("resize", function () {
					renderer.setSize(window.innerWidth, window.innerHeight);
				});
				
				// Touch gesture support for pinch-to-zoom
				var initialDistance = 0;
				var initialZoom = currentZoom;
				
				function getDistance(touches) {
					var dx = touches[0].clientX - touches[1].clientX;
					var dy = touches[0].clientY - touches[1].clientY;
					return Math.sqrt(dx * dx + dy * dy);
				}
				
				document.addEventListener('touchstart', function(e) {
					if (e.touches.length === 2) {
						e.preventDefault();
						initialDistance = getDistance(e.touches);
						initialZoom = currentZoom;
					}
				});
				
				document.addEventListener('touchmove', function(e) {
					if (e.touches.length === 2) {
						e.preventDefault();
						var currentDistance = getDistance(e.touches);
						var scaleFactor = currentDistance / initialDistance;
						var newZoom = initialZoom * scaleFactor;
						
						// Clamp zoom within limits
						newZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
						currentZoom = newZoom;
						updateZoom();
						
						// Auto-redirect to interactive view when reaching maximum zoom via touch - TEMPORARILY DISABLED
						if (currentZoom >= maxZoom) {
							// setTimeout(function() {
							// 	window.location.href = currentOrgan.interactivePage;
							// }, 500);
						}
					}
				});
				
				// Mouse wheel zoom for desktop
				document.addEventListener('wheel', function(e) {
					e.preventDefault();
					if (e.deltaY < 0) {
						zoomIn();
					} else {
						zoomOut();
					}
				});
				
				// Drag to rotate controls (Mouse + Touch)
				var isDragging = false;
				var previousMouseX = 0;
				var previousMouseY = 0;
				var previousTouchX = 0;
				var previousTouchY = 0;
				var dragSensitivity = 0.005; // Adjust for rotation speed
				
				// Mouse drag controls (Desktop)
				document.addEventListener('mousedown', function(e) {
					// Only start dragging on left click and not on UI buttons
					if (e.button === 0 && !e.target.closest('.zoom-btn') && !e.target.closest('button')) {
						isDragging = true;
						previousMouseX = e.clientX;
						previousMouseY = e.clientY;
						document.body.style.cursor = 'grabbing';
					}
				});
				
				document.addEventListener('mousemove', function(e) {
					if (isDragging) {
						var deltaX = e.clientX - previousMouseX;
						var deltaY = e.clientY - previousMouseY;
						
						// Horizontal drag = Y-axis rotation (left-right)
						currentRotationY += deltaX * dragSensitivity;
						
						// Vertical drag = X-axis rotation (up-down)
						currentRotationX += deltaY * dragSensitivity; // Drag up = rotate up
						
						updateRotation();
						previousMouseX = e.clientX;
						previousMouseY = e.clientY;
					}
				});
				
				document.addEventListener('mouseup', function(e) {
					if (isDragging) {
						isDragging = false;
						document.body.style.cursor = 'default';
					}
				});
				
				document.addEventListener('mouseleave', function(e) {
					if (isDragging) {
						isDragging = false;
						document.body.style.cursor = 'default';
					}
				});
				
				// Touch drag controls (Mobile/Tablet)
				var isTouchDragging = false;
				
				document.addEventListener('touchstart', function(e) {
					if (e.touches.length === 1) {
						// Check if not touching UI elements
						if (!e.target.closest('.zoom-btn') && !e.target.closest('button')) {
							isTouchDragging = true;
							previousTouchX = e.touches[0].clientX;
							previousTouchY = e.touches[0].clientY;
						}
					}
				});
				
				document.addEventListener('touchmove', function(e) {
					if (e.touches.length === 1 && isTouchDragging) {
						e.preventDefault();
						var currentX = e.touches[0].clientX;
						var currentY = e.touches[0].clientY;
						var deltaX = currentX - previousTouchX;
						var deltaY = currentY - previousTouchY;
						
						// Horizontal drag = Y-axis rotation (left-right)
						currentRotationY += deltaX * dragSensitivity;
						
						// Vertical drag = X-axis rotation (up-down)
						currentRotationX += deltaY * dragSensitivity; // Drag up = rotate up
						
						updateRotation();
						previousTouchX = currentX;
						previousTouchY = currentY;
					}
				});
				
				document.addEventListener('touchend', function(e) {
					isTouchDragging = false;
				});
				
				document.addEventListener('touchcancel', function(e) {
					isTouchDragging = false;
				});
				
				// Keyboard controls for rotation (Arrow keys / A & D)
				document.addEventListener('keydown', function(e) {
					if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
						e.preventDefault();
						rotateLeft();
					} else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
						e.preventDefault();
						rotateRight();
					}
				});

			}).catch((error) => {
				console.error('THREEAR initialization failed:', error);
				alert('AR initialization failed. Please make sure you have a camera and try again.');
			});

		</script>
	</body>
	
</html>
