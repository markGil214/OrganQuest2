<!doctype html>
<html>

	<head>
		<meta name='viewport' content='width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0'>
		<script src="vendor/three.101.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/three@0.101.1/examples/js/loaders/GLTFLoader.js"></script>
		<script src="THREEAR.js"></script>
		<title>AR Kidney Explorer - Kids Anatomy</title>
		<style>
			@import url('https://fonts.googleapis.com/css2?family=Fredoka+One:wght@400&family=Nunito:wght@400;600;700&display=swap');
			
			body {
				margin: 0px;
				overflow: hidden;
				font-family: 'Nunito', sans-serif;
				background-color: #000;
			}
			
			/* Compact Header Bar */
			.header-bar {
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				height: 60px;
				background: linear-gradient(135deg, #26de81 0%, #20bf6b 100%);
				display: flex;
				align-items: center;
				justify-content: space-between;
				padding: 0 15px;
				z-index: 100;
				box-shadow: 0 2px 15px rgba(0,0,0,0.2);
			}
			
			.header-title {
				color: white;
				font-family: 'Fredoka One', cursive;
				font-size: 1.3rem;
				margin: 0;
				text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
			}
			
			.header-controls {
				display: flex;
				gap: 10px;
				align-items: center;
			}
			
			.back-btn {
				background: white;
				color: #20bf6b;
				border: none;
				padding: 8px 16px;
				border-radius: 20px;
				font-weight: 700;
				font-size: 0.8rem;
				cursor: pointer;
				transition: all 0.2s ease;
				box-shadow: 0 2px 8px rgba(0,0,0,0.2);
			}
			
			.back-btn:hover {
				transform: translateY(-1px);
				box-shadow: 0 4px 12px rgba(0,0,0,0.3);
			}
			
			/* Floating Instructions Card */
			.instructions-card {
				position: absolute;
				top: 80px;
				left: 15px;
				background: rgba(255, 255, 255, 0.95);
				padding: 12px 15px;
				border-radius: 20px;
				max-width: 280px;
				z-index: 99;
				box-shadow: 0 4px 20px rgba(0,0,0,0.15);
				border: 3px solid #26de81;
				animation: float-in 0.8s ease-out;
			}
			
			@keyframes float-in {
				from { transform: translateX(-100%); opacity: 0; }
				to { transform: translateX(0); opacity: 1; }
			}
			
			.instructions-text {
				color: #333;
				font-size: 0.85rem;
				margin: 0;
				line-height: 1.4;
				font-weight: 600;
			}
			
			.kidney-emoji {
				font-size: 1.2rem;
				animation: filter-pulse 2s infinite;
			}
			
			@keyframes filter-pulse {
				0%, 100% { transform: scale(1); }
				50% { transform: scale(1.1) rotate(3deg); }
			}
			
			/* Compact Zoom Controls */
			.zoom-panel {
				position: absolute;
				bottom: 20px;
				right: 15px;
				background: rgba(255, 255, 255, 0.95);
				border-radius: 25px;
				padding: 8px;
				display: flex;
				flex-direction: column;
				gap: 8px;
				z-index: 100;
				box-shadow: 0 4px 20px rgba(0,0,0,0.15);
				border: 3px solid #20bf6b;
			}
			
			.zoom-btn {
				background: #20bf6b;
				border: none;
				color: white;
				width: 40px;
				height: 40px;
				border-radius: 50%;
				font-size: 1.2rem;
				font-weight: bold;
				cursor: pointer;
				display: flex;
				align-items: center;
				justify-content: center;
				transition: all 0.2s ease;
				box-shadow: 0 2px 8px rgba(0,0,0,0.2);
			}
			
			.zoom-btn:hover {
				background: #17a2b8;
				transform: scale(1.1);
			}
			
			.zoom-btn:active {
				transform: scale(0.95);
			}
			
			.zoom-display {
				background: white;
				color: #20bf6b;
				padding: 6px 10px;
				border-radius: 15px;
				font-size: 0.75rem;
				font-weight: 700;
				text-align: center;
				border: 2px solid #20bf6b;
			}
			
			/* Fun Fact Bubble */
			.fact-bubble {
				position: absolute;
				bottom: 20px;
				left: 15px;
				right: 90px;
				background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
				color: white;
				padding: 12px 18px;
				border-radius: 25px;
				text-align: center;
				z-index: 100;
				box-shadow: 0 4px 20px rgba(0,0,0,0.15);
				border: 3px solid #74b9ff;
				animation: bounce-in 1s ease-out 2s both;
			}
			
			@keyframes bounce-in {
				0% { transform: translateY(100%); opacity: 0; }
				60% { transform: translateY(-10px); opacity: 1; }
				100% { transform: translateY(0); opacity: 1; }
			}
			
			.fact-text {
				font-size: 0.9rem;
				font-weight: 700;
				margin: 0;
				text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
			}
			
			/* Zoom Hint Popup */
			.zoom-hint {
				position: absolute;
				top: 50%;
				left: 50%;
				transform: translate(-50%, -50%);
				background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
				color: white;
				padding: 15px 20px;
				border-radius: 25px;
				font-size: 0.9rem;
				font-weight: 700;
				z-index: 150;
				animation: pulse-hint 2s infinite;
				pointer-events: none;
				text-align: center;
				max-width: 220px;
				box-shadow: 0 6px 25px rgba(0,0,0,0.3);
				border: 3px solid #74b9ff;
			}
			
			@keyframes pulse-hint {
				0% { opacity: 0.9; transform: translate(-50%, -50%) scale(1); }
				50% { opacity: 1; transform: translate(-50%, -50%) scale(1.05); }
				100% { opacity: 0.9; transform: translate(-50%, -50%) scale(1); }
			}
			
			/* Hide instructions after some time */
			.instructions-card.fade-out {
				animation: fade-out 0.5s ease-out 8s both;
			}
			
			@keyframes fade-out {
				from { opacity: 1; transform: translateX(0); }
				to { opacity: 0; transform: translateX(-100%); }
			}
			
			/* Mobile responsive adjustments */
			@media (max-width: 480px) {
				.header-title {
					font-size: 1.1rem;
				}
				
				.instructions-card {
					max-width: 240px;
					padding: 10px 12px;
				}
				
				.instructions-text {
					font-size: 0.8rem;
				}
				
				.fact-bubble {
					right: 70px;
					padding: 10px 15px;
				}
				
				.fact-text {
					font-size: 0.8rem;
				}
				
				.zoom-btn {
					width: 35px;
					height: 35px;
					font-size: 1rem;
				}
				
				.zoom-display {
					font-size: 0.7rem;
					padding: 4px 8px;
				}
			}
			
			/* Very small screens */
			@media (max-width: 320px) {
				.header-bar {
					height: 50px;
					padding: 0 10px;
				}
				
				.header-title {
					font-size: 1rem;
				}
				
				.back-btn {
					padding: 6px 12px;
					font-size: 0.7rem;
				}
				
				.instructions-card {
					top: 65px;
					left: 10px;
					max-width: 200px;
					padding: 8px 10px;
				}
				
				.instructions-text {
					font-size: 0.75rem;
				}
			}
		</style>
	</head>

	<body>
		<!-- Compact Header Bar -->
		<div class="header-bar">
			<h1 class="header-title">ü´ò Kidney Explorer</h1>
			<div class="header-controls">
				<button class="back-btn" onclick="window.history.back()">‚Üê Back</button>
			</div>
		</div>
		
		<!-- Floating Instructions -->
		<div class="instructions-card" id="instructionsCard">
			<p class="instructions-text">
				<span class="kidney-emoji">ü´ò</span> Point your camera at the AR marker to see filtering kidneys! Watch them clean your blood!
			</p>
		</div>
		
		<!-- Fun Fact Bubble -->
		<div class="fact-bubble">
			<p class="fact-text">üåä Your kidneys filter 50 gallons of blood every day!</p>
		</div>
		
		<!-- Zoom Hint Popup -->
		<div class="zoom-hint" id="zoomHint" style="display: none;">
			üîç Zoom all the way in to explore the kidney's regions!
		</div>
		
		<!-- Compact Zoom Panel -->
		<div class="zoom-panel">
			<button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
			<div class="zoom-display" id="zoomDisplay">100%</div>
			<button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
		</div>

		<script>
			// Initialize Three.js renderer with transparency
			var renderer = new THREE.WebGLRenderer({
				alpha: true,
				antialias: true
			});
			renderer.setClearColor(new THREE.Color('lightgrey'), 0);
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.domElement.style.position = 'absolute';
			renderer.domElement.style.top = '0px';
			renderer.domElement.style.left = '0px';
			document.body.appendChild(renderer.domElement);
		
			// Initialize scene and camera
			var scene = new THREE.Scene();
			var camera = new THREE.Camera();
			scene.add(camera);

			// Create group for kidney objects
			var kidneyGroup = new THREE.Group();
			scene.add(kidneyGroup);
			
			// Zoom variables
			var currentZoom = 1.0;
			var minZoom = 0.5;
			var maxZoom = 3.0;
			var zoomStep = 0.2;
			
			// Auto-hide instructions after 8 seconds
			setTimeout(function() {
				var card = document.getElementById('instructionsCard');
				if (card) {
					card.classList.add('fade-out');
				}
			}, 8000);
			
			// Zoom functions
			function zoomIn() {
				if (currentZoom < maxZoom) {
					currentZoom += zoomStep;
					updateZoom();
					
					// Auto-redirect to interactive view when reaching maximum zoom
					if (currentZoom >= maxZoom) {
						// Show special transition message
						showTransitionMessage();
						setTimeout(function() {
							window.location.href = 'kidney-interactive.html?zoom=close';
						}, 1500); // Longer delay for smooth transition
					}
				}
			}
			
			function zoomOut() {
				if (currentZoom > minZoom) {
					currentZoom -= zoomStep;
					updateZoom();
				}
			}
			
			function updateZoom() {
				// Apply zoom to the kidney group
				kidneyGroup.userData.zoomScale = currentZoom;
				document.getElementById('zoomDisplay').textContent = Math.round(currentZoom * 100) + '%';
				
				// Show visual feedback when approaching max zoom
				var zoomDisplay = document.getElementById('zoomDisplay');
				if (currentZoom >= maxZoom * 0.8) {
					zoomDisplay.style.background = '#26de81';
					zoomDisplay.style.color = 'white';
					zoomDisplay.style.borderColor = '#26de81';
					// Hide zoom hint when close to max zoom
					document.getElementById('zoomHint').style.display = 'none';
				} else {
					zoomDisplay.style.background = 'white';
					zoomDisplay.style.color = '#20bf6b';
					zoomDisplay.style.borderColor = '#20bf6b';
				}
			}
			
			// Function to show transition message
			function showTransitionMessage() {
				var hint = document.getElementById('zoomHint');
				hint.innerHTML = 'ü´ò Exploring kidney regions!';
				hint.style.background = 'linear-gradient(135deg, #26de81 0%, #20bf6b 100%)';
				hint.style.display = 'block';
				hint.style.animation = 'pulse-hint 0.5s infinite';
			}
			
			// Function to show zoom hint
			function showZoomHint() {
				setTimeout(function() {
					document.getElementById('zoomHint').style.display = 'block';
					// Auto-hide after 6 seconds
					setTimeout(function() {
						document.getElementById('zoomHint').style.display = 'none';
					}, 6000);
				}, 4000); // Show hint 4 seconds after kidney appears
			}
			

		
			// Initialize THREEAR source
			var source = new THREEAR.Source({ renderer, camera });

			THREEAR.initialize({ source: source }).then((controller) => {

				// Load 3D Kidney Model
				var loader = new THREE.GLTFLoader();
				loader.load('../models/kidney/kidney.glb', function(gltf) {
					var kidneyModel = gltf.scene;
					
					// Scale the kidney model to appropriate size for AR
					kidneyModel.scale.set(2.0, 2.0, 2.0);
					kidneyModel.position.y = 0.5;
					
					// Keep exact original colors from the 3D model
					
					// Add the kidney model to the group
					kidneyGroup.add(kidneyModel);
					
					// Initialize zoom scale
					kidneyGroup.userData.zoomScale = currentZoom;
					
					// Show zoom hint to encourage interaction
					showZoomHint();
					
					// Add filtering animation to the model
					var originalScale = { x: 2.0, y: 2.0, z: 2.0 };
					var time = 0;
					
					// Animation loop for filtering kidney
					function animateKidney() {
						time += 0.016; // 60fps
						var filterScale = 1 + Math.sin(time * 2) * 0.06; // Gentle filtering pulsing
						
						// Apply both zoom and filtering animation
						var zoomScale = kidneyGroup.userData.zoomScale || 1.0;
						kidneyModel.scale.set(
							originalScale.x * filterScale * zoomScale,
							originalScale.y * filterScale * zoomScale,
							originalScale.z * filterScale * zoomScale
						);
						kidneyModel.rotation.y += 0.004; // Slow rotation
					}
					
					// Start the animation
					var animationId;
					function animate() {
						animationId = requestAnimationFrame(animate);
						animateKidney();
						
						controller.update(source.domElement);
						renderer.render(scene, camera);
					}
					animate();
					
				}, function(progress) {
					console.log('Loading kidney model...', (progress.loaded / progress.total * 100) + '%');
				}, function(error) {
					console.error('Error loading kidney model:', error);
					// Fallback to new_kidney model
					loadFallbackKidney();
				});

				// Fallback function to try alternative kidney model
				function loadFallbackKidney() {
					var loader = new THREE.GLTFLoader();
					loader.load('models/kidney/kidney.glb', function(gltf) {
						var kidneyModel = gltf.scene;
						
						// Scale the kidney model appropriately
						kidneyModel.scale.set(1.5, 1.5, 1.5);
						kidneyModel.position.y = 0.5;
						
						// Keep exact original colors from the 3D model
						
						kidneyGroup.add(kidneyModel);
						kidneyGroup.userData.zoomScale = currentZoom;
						showZoomHint();
						
						// Animation for fallback kidney
						var originalScale = { x: 1.5, y: 1.5, z: 1.5 };
						var time = 0;
						
						function animateFallbackKidney() {
							requestAnimationFrame(animateFallbackKidney);
							time += 0.016;
							
							var filterScale = 1 + Math.sin(time * 2) * 0.06;
							var zoomScale = kidneyGroup.userData.zoomScale || 1.0;
							kidneyModel.scale.set(
								originalScale.x * filterScale * zoomScale,
								originalScale.y * filterScale * zoomScale,
								originalScale.z * filterScale * zoomScale
							);
							kidneyModel.rotation.y += 0.004;
							
							controller.update(source.domElement);
							renderer.render(scene, camera);
						}
						animateFallbackKidney();
						
					}, undefined, function(error) {
						console.error('Error loading fallback kidney model:', error);
						createSimpleKidney();
					});
				}

				// Final fallback function to create simple kidney if GLTF fails
				function createSimpleKidney() {
					// Create kidney geometry (bean-shaped)
					var kidneyGeometry = new THREE.SphereGeometry(1.2, 32, 32);
					kidneyGeometry.scale(1.3, 1.8, 0.9); // Make kidney-shaped
					
					var kidneyMaterial = new THREE.MeshPhongMaterial({ 
						color: 0x26de81,
						shininess: 30,
						transparent: true,
						opacity: 0.9
					});
					
					var kidney = new THREE.Mesh(kidneyGeometry, kidneyMaterial);
					kidney.position.y = 0.5;
					kidneyGroup.add(kidney);
					
					// Show zoom hint for fallback kidney too
					showZoomHint();
					
					// Add filtering particles
					var filteringParticles = [];
					for (let i = 0; i < 20; i++) {
						var particleGeometry = new THREE.SphereGeometry(0.03, 8, 8);
						var particleMaterial = new THREE.MeshBasicMaterial({ color: 0x74b9ff, transparent: true, opacity: 0.7 });
						var particle = new THREE.Mesh(particleGeometry, particleMaterial);
						particle.position.set((Math.random() - 0.5) * 2.2, Math.random() * 2.5 + 0.2, (Math.random() - 0.5) * 1.8);
						filteringParticles.push(particle);
						kidneyGroup.add(particle);
					}
					
					// Add simple animation for fallback kidney
					var time = 0;
					function animateFallbackKidney() {
						requestAnimationFrame(animateFallbackKidney);
						time += 0.016;
						
						// Kidney filtering animation (gentle pulsing)
						var pulseScale = 1 + Math.sin(time * 2) * 0.06;
						var zoomScale = kidneyGroup.userData.zoomScale || 1.0;
						kidney.scale.set(
							pulseScale * zoomScale * 1.3,
							pulseScale * zoomScale * 1.8,
							pulseScale * zoomScale * 0.9
						);
						kidney.rotation.y += 0.003;
						
						// Animate filtering particles
						filteringParticles.forEach((particle, index) => {
							particle.position.y += Math.sin(time + index) * 0.008;
							particle.rotation.x += 0.02;
							particle.rotation.y += 0.02;
						});
						
						controller.update(source.domElement);
						renderer.render(scene, camera);
					}
					animateFallbackKidney();
				}

				// Add maximum brightness lighting setup
				var ambientLight = new THREE.AmbientLight(0xffffff, 2.5); // Maximum ambient light
				scene.add(ambientLight);
				
				var directionalLight = new THREE.DirectionalLight(0xffffff, 3.0); // Maximum directional light
				directionalLight.position.set(1, 1, 1);
				scene.add(directionalLight);
				
				// Add second directional light from opposite angle
				var directionalLight2 = new THREE.DirectionalLight(0xffffff, 2.0);
				directionalLight2.position.set(-1, 1, -1);
				scene.add(directionalLight2);
				
				// Add maximum brightness hemisphere lighting
				var hemisphereLight = new THREE.HemisphereLight(0xffffff, 0xffffff, 1.5);
				scene.add(hemisphereLight);
				
				// Add point lights for extra illumination
				var pointLight1 = new THREE.PointLight(0xffffff, 1.5, 100);
				pointLight1.position.set(2, 2, 2);
				scene.add(pointLight1);
				
				var pointLight2 = new THREE.PointLight(0xffffff, 1.5, 100);
				pointLight2.position.set(-2, 2, -2);
				scene.add(pointLight2);

				// Create pattern marker for tracking
				var patternMarker = new THREEAR.PatternMarker({
					patternUrl: 'data/patt.hiro',
					markerObject: kidneyGroup
				});

				controller.trackMarker(patternMarker);

				// Handle window resize
				window.addEventListener('resize', function() {
					renderer.setSize(window.innerWidth, window.innerHeight);
				});
				
				// Touch gesture support for pinch-to-zoom
				var initialDistance = 0;
				var initialZoom = currentZoom;
				
				function getDistance(touches) {
					var dx = touches[0].clientX - touches[1].clientX;
					var dy = touches[0].clientY - touches[1].clientY;
					return Math.sqrt(dx * dx + dy * dy);
				}
				
				document.addEventListener('touchstart', function(e) {
					if (e.touches.length === 2) {
						e.preventDefault();
						initialDistance = getDistance(e.touches);
						initialZoom = currentZoom;
					}
				});
				
				document.addEventListener('touchmove', function(e) {
					if (e.touches.length === 2) {
						e.preventDefault();
						var currentDistance = getDistance(e.touches);
						var scaleFactor = currentDistance / initialDistance;
						var newZoom = initialZoom * scaleFactor;
						
						// Clamp zoom within limits
						newZoom = Math.max(minZoom, Math.min(maxZoom, newZoom));
						currentZoom = newZoom;
						updateZoom();
						
						// Auto-redirect to interactive view when reaching maximum zoom via touch
						if (currentZoom >= maxZoom) {
							showTransitionMessage();
							setTimeout(function() {
								window.location.href = 'kidney-interactive.html?zoom=close';
							}, 1500);
						}
					}
				});
				
				// Mouse wheel zoom for desktop
				document.addEventListener('wheel', function(e) {
					e.preventDefault();
					if (e.deltaY < 0) {
						zoomIn();
					} else {
						zoomOut();
					}
				});

			}).catch((error) => {
				console.error('THREEAR initialization failed:', error);
				alert('AR initialization failed. Please make sure you have a camera and try again.');
			});

		</script>
	</body>
	
</html>
